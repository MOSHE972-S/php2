name: Remove .env from history automatically

on:
  push:
    branches:
      - main  # ענף שאתה רוצה להפעיל עליו את ה־workflow

jobs:
  remove-env-history:
    runs-on: ubuntu-latest  # נריץ על סביבה מנוהלת של GitHub Actions
    
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3  # פעולת checkout לסטור את המאגר
        with:
          fetch-depth: 0  # חשוב לוודא שאתה שואב את כל ההיסטוריה של המאגר

      - name: Check if python3 and git-filter-repo are installed
        run: |
          echo "Checking if python3 and git-filter-repo are already installed..."
          python3 --version || { echo "python3 not found! Installing..." && sudo apt-get install -y python3-pip; }
          git-filter-repo --version || { echo "git-filter-repo not found! Installing..." && sudo apt-get install -y python3-pip && pip3 install git-filter-repo; }
          echo "Both python3 and git-filter-repo are installed."

      - name: Configure git user
        run: |
          echo "Configuring git user..."
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --list  # הדפסת כל הגדרות ה־git

      - name: Run git filter-repo to remove .env from history
        run: |
          echo "Running git filter-repo..."
          git filter-repo --path .env --invert-paths --force
          echo ".env has been removed from history."

      - name: Check git status after filter-repo
        run: |
          echo "Checking git status..."
          git status  # הדפסת מצב ה־git לאחר שינוי ההיסטוריה

      - name: Remove .env from working tree
        run: |
          echo "Removing .env from working tree..."
          rm -f .env  # מוחק את הקובץ .env מה־working tree
          git status  # לוודא שהקובץ נמחק מה־working tree

      - name: Commit changes if any
        run: |
          echo "Checking if there are any changes to commit..."
          git diff --exit-code || {
            echo "Changes detected, committing..."
            git add .
            git commit -m "Remove .env from history"
            git log --oneline -n 5  # הדפסת חמשת הקומיטים האחרונים לבדוק שהכל בסדר
          }
          echo "No changes to commit."

      - name: Set up remote repository
        run: |
          echo "Setting up remote repository..."
          git remote set-url origin https://github.com/${{ github.repository }}.git  # הגדרת כתובת ה־origin
          git remote -v  # הדפסת את כתובת ה־remote

      - name: Push changes to repository
        run: |
          echo "Pushing changes to remote repository..."
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main --force  # דחיפת השינויים עם --force
          echo "Changes have been pushed to the remote repository."
